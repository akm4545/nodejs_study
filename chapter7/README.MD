# **NoSQL 데이터베이스 몽고디비 사용하기**  
# **몽고디비 소개**  
몽고디비는 NoSQL 데이터베이스다. NoSQL 데이터베이스는 데이터 모델에 따라서 키-밸류(Key-Value), 컬럼, 도큐먼트, 그래프 타입으로 분류할 수 있다. 
그중 몽고디비는 도큐먼트 타입이다.  
  
- 키-밸류 타입은 키를 기준으로 데이터를 조회하고 값으로 데이터를 저장한다.  
- 도큐먼트 타입은 JSON과 유사한 형식의 객체를 담은 데이터를 저장한다.  
- 그래프 타입은 노드를 사용하여 데이터를 저장하고 에지를 사용해 데이터 관계를 저장한다.  
  
# **데이터베이스 기본 용어**  
- 테이블: 특정 주제에 대한 행과 열로 이루어진 데이터의 모음.  
- 로우: 관계형 데이터베이스의 테이블에서 단일 구조 데이터 항목. 레코드라고도 부른다.  
- 컬럼: 관계형 데이터베이스의 테이블에서 특정한 자료의 값 혹은 테이블에서의 열  
- 기본키: 데이터 식별 시 필요한 키.  
- 왜래키: 두 테이블을 연결하는 데 사용하는 키.  
- RDB: 관계형 데이터베이스.  
- 스키마: 데이터베이스 테이블의 명세(길이, 자료형 등)를 기술한 데이터.  
- 모델: 데이터베이스의 특정 테이블과 테이블에 있는 컬럼들의 형태를 정의한 클래스.  
- 컬렉션: 몽고디비에서 사용하는 용어. 도큐먼트의 집합을 컬력센이라고 한다. 관계형 데이터베이스의 테이블과 동일한 의미.  
- 조인: 두개 이상의 테이블 또는 컬렉션을 조합하여 데이터를 보여주는 기법.  
- 트랜잭션: 데이터 변경을 수행하는 작업 단위.  
  
## **알아두면 좋은 용어**  
- 클러스터: 데이터 처리량을 높일 목적으로 데이터를 여러 서버(샤드)에 저장하는 기법.  
- 샤드: 큰 데이터베이스를 작은 단위로 분할하는 기능을 의미. 샤드를 사용하여 데이터를 작은 단위로 분할하여 노드(데이터를 가지고 있는 서버)에 분산시켜서 
저장할 수 있다. 샤드를 사용하면 대규모 데이터베이스를 다루는 시스템에서 성능과 확장성을 향상시킬 수 있다.  
  
# **몽고디비 특징**  
몽고디비에서 도큐먼트는 BSON이라는 데이터 포맷이다. BSON은 Binary JSON의 의미로 JSON을 바이너리 형식으로 저장하는 형태다. 또한 기존 JSON에는 지원하지 
않는 자료형인 Date와 BinData(바이너리데이터) 타입을 지원한다. JSON과 비슷한 형태이므로 이해하기 쉽고 바이너리로 저장하기 때문에 용량이 문자열보다는 
작고 성능이 좋다.  
  
![img.png](image/img.png)  
  
몽고디비는 JSON과 유사한 BSON을 사용하므로 자바스크립트와 호환성이 좋다. 몽고디비에서 데이터를 조회할 때 사용하는 쿼리도 자바스크립트를 사용한다. 
최근에는 인기가 조금 식긴 했지만 예전에는 MEAN 스택이라고 해서 몽고디비, 익스프레스, 앵귤러, 엔진엑스를 사용하는 기술 스택이 인기가 있었다. 몽고디비는 
데이터베이스, 익스프레스는 백엔드, 앵귤러는 프론트엔드, 엔진엑스는 웹 서버다. MEAN 스택의 핵심 언어는 자바스크립트다. 몽고디비는 자바스크립트 친화적이다.  
  
# **몽고디비 아틀라스 설정하기**  
mongodb.com에 있는 몽고디비 서버군으로 클라우드로 사용할 수 있는 몽고디비 아틀라스(MongoDB Atlas), 무료 설치 버전인 커뮤니티 서버(Community Server), 
커뮤니티 서버에 추가적인 기능과 서프트를 제공하는 유료 설치 버전 엔터프라이즈 서버(Enterprise Server)가 있다.  
  
가장 빠르고 간편하게 사용할 수 있는 몽고디비 아틀라스를 설정한다.  
  
1. https://www.mongodb.com/atlas에 접속해 Try Free 버튼을 클릭한다.  
2. 원하는 방식으로 안내에 따라 가입한다.  
3. 회원가입 후 약관에 동의하고 Submit 버튼을 눌러 다음으로 진행한다.  
4. 설문조사를 스킵하고 다음으로 진행한다.  
5. 다음으로 사용할 데이터베이스를 선택한다. 무료 플랜은 메모리와 CPU를 공유하며 최대 저장 공간은 512MB다. 무료 플랜인 M0을 선택하고 Provider로는 AWS를 
선택한다. Region은 Seoul (op-northeast-2)를 선택한다. Name은 그대로 두고 Create 버튼을 클릭한다.  
  
![img.png](image/img2.png)  
  
6. 몽고디비 접속 설정을 하는 페이지가 보인다.  
  
![img.png](image/img3.png)  
  
1번은 몽고 디비를 접속할 때 아이디/패스워드 기반으로 할지, 인증서 기반으로 할지 선택할 수 있다. Username and Password를 선택한다. 2번 항목에 유저명과 
패스워드를 입력한다. 3번 버튼 Create User를 눌러서 유저를 생성한다. 그러면 다음과 같이 유저명과 인증 타입 부분이 추가된다.  
  
![img.png](image/img4.png)  
  
4번 항목에 기본적으로는 로컬 환경에서 접속이 선택되어 있다. 5번 항목 Add My Current IP Address를 눌러서 로컬 환경의 IP를 등록한다. 그러면 다음과 
같이 IP가 추가된다.  
  
![img.png](image/img5.png)  
  
6번 항목 Finish and Close 버튼을 클릭해 설정을 마무리한다. 버튼을 클릭하면 안내 팝업이 뜬다. Database Access나 Network Access는 왼쪽 메뉴에서 
나중에도 접근이 가능하므로 설치가 잘 되었는지 Go to Databases를 클릭해 확인한다.  
  
7. 데이터베이스 관련 설정을 모두 마치면 데이터베이스 상태를 확인할 수 있는 페이지로 이동된다. Connect 버튼을 눌러서 접속 정보를 확인한다.  
  
![img.png](image/img6.png)  
  
8. 클러스터에 접속하는 방법은 3가지다. 첫 번째는 몽고디비 셸을 사용하는 방법, 두 번째는 애플리케이션에서 몽고디비 드라이버를 사용하는 방법, 세 번째는 
몽고디비 콤파스(MongoDB Compass) GUI 프로그램을 사용하는 방법이다. 우리는 Node.js 프로그램에서 접속이 가능한지 궁금하니 두 번째 방법인 애플리케이션에서 
몽고디비 드라이버를 사용해 접속이 되는지 확인한다. Connect your application을 클릭한다.  
  
![img.png](image/img7.png)  
  
9. 1번 항목에는 Node.js가 자동으로 선택되어 있다. 2번 항목에 있는 부분을 클릭해 모든 소스 코드가 보이도록 한다. 3번 아이콘을 클릭해 소스를 복사한다.  
  
![img.png](image/img8.png)  
  
10. try-mong 디텍터리를 생성 후 아래에 test-connection.js 파일을 생성하고 복사한 코드를 붙여넣는다.  
  
![img.png](image/img9.png)  
  
몽고디비 연결 정보 uri는 프로토콜이 mongodb+srv다. 몽고디비 아틀라스 연결 시 사용하며 드라이버에서는 <호스트명> + <도메인네임>으로 DNS에 서버 
주소를 질의한다. myFirstDatabase는 데이터베이스 이름이다. 몽고디비에서는 데이터베이스를 먼저 만들지 않아도 사용할 수 있다. retryWrites=true 옵션은 
네트워크 오류가 발생하거나 정상적인 연결을 찾을 수 없을 때 쓰기 작업을 자동으로 재시도하는 옵션이며 w=majority 옵션은 쓰기를 시도할 때 다수(majority)의 
인스턴스에 쓰기 요청을 전달하고 성공 확인을 받는다. 데이터베이스(클러스터)가 3대라면 최소 2대의 승인이 있어야 쓰기가 가능하다는 뜻이다. 1대가 아니고 
전부도 아닌 다수 옵션을 사용하는 이유는 1대에만 쓰기가 됐는지 확인한다면 쓰기 요청을 받은 장비에 장애가 날 경우 데이터가 유실될 수 있다. 모든 서버에 
쓰기가 되었는지 확인하는 경우에는 1대라도 장애가 나면 쓰기가 실패한다. 이러한 이유로 최소한의 서버가 문제가 생기는 경우에도 디비 서버로의 요청이 정상 
작동하도록 다수의 서버 옵션을 선택한다.  
  
2번 항목은 MongoClient 객체를 생성하는 코드다. connect() 함수를 사용해 몽고디비에 접속을 시도한다. 4번 항목은 test 데이터베이스에 있는 devices 
컬렉션 정보를 가져오는 코드다. 컬렉션은 RDB의 테이블과 유사한 역할을 한다.  
  
11. 코드를 실행한다.  
node test-connection.js  
  
12. 실행 결과로 몽고디비 모듈이 없다는 에러가 난다. 몽고디비 패키지를 설치하고 다시 실행한다.  
npm i mongodb  
node test-connection.js  
  
결과에는 아무것도 나오지 않는다. 몽고비디와 커넥션은 맺었지만 아무런 정보도 호출하지 않았기 때문이다.  
  
13. 데이터베이스 정보를 출력하도록 소스 코드를 수정한다.  
try-mongo/test-connection.js  
  
admin() 함수는 admin DB의 인스턴스를 가져 올 수 있게 해준다. admin DB 인스턴스에는 listDatabases() 함수가 있고 해당 함수를 실행하면 데이터베이스들의 
정보를 반환해준다. 아직은 아무런 데이터가 없어서 데이터베이스에는 admin과 local만 있다. admin, local은 기본적으로 생성되어 있는 데이터베이스다. run() 
함수에서는 데이터베이스 목록을 출력한 다음 마지막에 몽고디비 커넥션을 닫도록 코드를 작성했다.  
  
14. 다시 실행하여 결과를 확인한다.  
  
# **몽고디비 CRUD API 만들기**  
1. try-mongo 디렉터리 아래에 파일을 생서하고 실행한다.  
try-mongo/test-crud.js  
  
MongoClient 인스턴스를 생성해 client 변수에 담는다. useNewUrlParser 옵션은 몽고디비 드라이버 3.0 버전 이후로 생긴 새로운 URL 파서를 사용한다는 
옵션이다. 몽고디비 아틀라스를 연결할 때는 해당 옵션을 사용해야 한다. client.connect() 함수를 사용해 서버에 연결을 시도한다.  
  
client.db('test')는 test 데이터베이스를 사용한다는 뜻이고 collection('person')은 person 컬렉션을 사용한다는 뜻이다. 데이터베이스가 생성되어 
있지 않으면 새로 생성한다. 문서를 하나 추가할 때는 insertOne() 함수를 사용하며 인수로는 JSON 형식의 객체를 넣으면 된다. 문서 찾기에는 find() 
함수를 사용한다. 인수로는 객체의 속성과 찾고자 하는 값을 넣어주면 된다. 결괏값이 여러 개일 수 있으므로 toArray() 함수를 사용해 배열로 반환해준다.  
  
문서를 갱신할 떄는 갱신할 도큐먼트를 찾는 데 사용할 JSON 객체를 첫 번째 인수로 넣고 두 번째 인수에는 $set의 값으로 업데이트할 값을 넣는다. $set은 
몽고디비의 연산자로 값을 필드에 지정할 떄 사용한다.  
  
![img.png](image/img10.png)  
  
2. 터미널에서 코드를 실행해본다.  
  
